<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TodoList Demo - 静态原型</title>
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--muted:#6b7280;--accent:#2563eb;--danger:#ef4444}
    body{font-family:Segoe UI, Roboto, "Helvetica Neue", Arial; background:var(--bg); margin:0; color:#0f172a}
    .container{max-width:900px;margin:24px auto;padding:16px}
    header{display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:20px}
    .search{margin-left:auto}
    .card{background:var(--card);border-radius:8px;padding:12px;box-shadow:0 1px 2px rgba(15,23,42,0.04)}
    .new-task{display:flex;gap:8px;margin:12px 0}
    input[type=text]{padding:8px;border-radius:6px;border:1px solid #e6e6f0;flex:1}
    button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .filters{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .filters button{background:#eef2ff;color:var(--accent);padding:6px 8px;border-radius:6px}
    .task-list{margin-top:8px}
    .task{display:flex;align-items:center;gap:12px;padding:8px;border-radius:6px;border:1px solid #f0f0f5;margin-bottom:8px}
    .task .title{flex:1}
    .muted{color:var(--muted);font-size:13px}
    .priority{padding:4px 8px;border-radius:999px;font-size:12px;background:#f1f5f9}
    .actions button{background:transparent;color:var(--muted);border:none;cursor:pointer}
    .completed .title{text-decoration:line-through;color:#9ca3af}
    .toast{position:fixed;right:20px;bottom:20px;background:#111827;color:#fff;padding:10px 16px;border-radius:8px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>TodoList Demo</h1>
      <div class="search">
        <input id="searchInput" type="text" placeholder="搜索任务..." style="width:220px" />
      </div>
    </header>

    <div class="card">
      <div class="new-task">
        <input id="newTaskInput" type="text" placeholder="输入新任务标题，按回车或点击添加" />
        <button id="addBtn">添加</button>
      </div>

      <div class="filters">
        <div>
          <button data-filter="all">全部</button>
          <button data-filter="active">未完成</button>
          <button data-filter="completed">已完成</button>
        </div>
        <div style="margin-left:auto">
          <label class="small muted">排序：</label>
          <select id="sortSelect">
            <option value="created">创建时间</option>
            <option value="due">到期日</option>
            <option value="priority">优先级</option>
          </select>
        </div>
      </div>

      <div id="taskList" class="task-list"></div>

    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
    // 简单原型：使用 localStorage 持久化
    const STORAGE_KEY = 'todo_demo_tasks_v1'
    let tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')
    let lastDeleted = null

    const el = {
      newTaskInput: document.getElementById('newTaskInput'),
      addBtn: document.getElementById('addBtn'),
      taskList: document.getElementById('taskList'),
      searchInput: document.getElementById('searchInput'),
      toast: document.getElementById('toast'),
      sortSelect: document.getElementById('sortSelect')
    }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)) }

    function uid(){ return Math.random().toString(36).slice(2,9) }

    function render(){
      const q = (el.searchInput.value || '').toLowerCase()
      const filter = document.querySelector('.filters button[data-active]')?.dataset.filter || 'all'
      const sort = el.sortSelect.value
      let items = tasks.slice()
      if(filter === 'active') items = items.filter(t=>!t.completed)
      if(filter === 'completed') items = items.filter(t=>t.completed)
      if(q) items = items.filter(t=>t.title.toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q))

      if(sort === 'due') items.sort((a,b)=> (a.due_date||'') > (b.due_date||'') ? 1 : -1)
      else if(sort === 'priority') items.sort((a,b)=> (b.priority||0) - (a.priority||0))
      else items.sort((a,b)=> (a.created_at > b.created_at) ? -1 : 1)

      el.taskList.innerHTML = ''
      if(items.length === 0){ el.taskList.innerHTML = '<div class="muted">无任务，试试添加一个吧</div>' ; return }

      items.forEach(t=>{
        const div = document.createElement('div')
        div.className = 'task ' + (t.completed ? 'completed' : '')
        div.innerHTML = `
          <input type="checkbox" ${t.completed? 'checked':''} data-id="${t.id}" />
          <div class="title">${escapeHtml(t.title)}</div>
          <div class="priority small">${t.priorityText || ''}</div>
          <div class="muted small">${t.due_date || ''}</div>
          <div class="actions">
            <button data-edit="${t.id}">编辑</button>
            <button data-delete="${t.id}">删除</button>
          </div>
        `
        el.taskList.appendChild(div)
      })
    }

    function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    function addTask(title){
      if(!title || !title.trim()) return showToast('请输入任务标题')
      const t = { id: uid(), title: title.trim(), description:'', created_at: new Date().toISOString(), updated_at: new Date().toISOString(), due_date: '', completed:false, priority:1, priorityText:'中' }
      tasks.unshift(t); save(); render(); el.newTaskInput.value = ''
    }

    function toggleComplete(id){
      const t = tasks.find(x=>x.id===id); if(!t) return
      t.completed = !t.completed; t.updated_at = new Date().toISOString(); save(); render()
    }

    function editTask(id){
      const t = tasks.find(x=>x.id===id); if(!t) return
      const newTitle = prompt('编辑任务标题：', t.title)
      if(newTitle === null) return
      t.title = newTitle.trim() || t.title; t.updated_at = new Date().toISOString(); save(); render(); showToast('已保存')
    }

    function deleteTask(id){
      const idx = tasks.findIndex(x=>x.id===id); if(idx===-1) return
      lastDeleted = tasks.splice(idx,1)[0]; save(); render(); showUndoToast('已删除任务', ()=>{ if(lastDeleted){ tasks.unshift(lastDeleted); lastDeleted=null; save(); render(); showToast('已撤销') } })
    }

    function showToast(msg, ms=2000){ el.toast.style.display='block'; el.toast.textContent = msg; setTimeout(()=>el.toast.style.display='none', ms) }

    function showUndoToast(msg, undo){ el.toast.style.display='block'; el.toast.innerHTML = msg + ' <button style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.2);padding:4px 8px;border-radius:6px;margin-left:8px">撤销</button>'
      const btn = el.toast.querySelector('button'); btn.onclick = ()=>{ undo(); el.toast.style.display='none' }
      setTimeout(()=>{ if(el.toast.style.display==='block') el.toast.style.display='none'; lastDeleted=null }, 5000)
    }

    // 事件
    el.addBtn.addEventListener('click', ()=>addTask(el.newTaskInput.value))
    el.newTaskInput.addEventListener('keydown', e=>{ if(e.key==='Enter') addTask(el.newTaskInput.value) })

    document.addEventListener('click', e=>{
      if(e.target.matches('[data-delete]')){ deleteTask(e.target.getAttribute('data-delete')) }
      if(e.target.matches('[data-edit]')){ editTask(e.target.getAttribute('data-edit')) }
      if(e.target.matches('.task input[type=checkbox]')){ const id = e.target.nextElementSibling ? e.target.nextElementSibling.nextElementSibling?.getAttribute('data-id') : null; /* fallback */ }
    })

    // checkbox handler (delegate)
    el.taskList.addEventListener('click', e=>{
      if(e.target.tagName === 'INPUT' && e.target.type === 'checkbox'){
        const parent = e.target.parentElement
        const id = parent.querySelector('[data-delete]')?.getAttribute('data-delete') || parent.querySelector('[data-edit]')?.getAttribute('data-edit')
        if(id) toggleComplete(id)
      }
    })

    // filter buttons
    document.querySelectorAll('.filters button[data-filter]').forEach(b=>b.removeAttribute('data-filter'))
    document.querySelectorAll('.filters button').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.filters button').forEach(x=>x.removeAttribute('data-active'))
        b.setAttribute('data-active','true')
        // set dataset.filter
        b.dataset.filter = b.textContent.toLowerCase().includes('未') ? 'active' : (b.textContent.toLowerCase().includes('已') ? 'completed' : 'all')
        render()
      })
    })

    // search
    el.searchInput.addEventListener('input', ()=>render())
    el.sortSelect.addEventListener('change', ()=>render())

    // init default active filter to all
    const btns = document.querySelectorAll('.filters button')
    if(btns[0]) btns[0].setAttribute('data-active','true'), btns[0].dataset.filter='all'

    // seed sample data if empty
    if(tasks.length === 0){
      tasks = [
        {id:uid(),title:'买牛奶',description:'',created_at:new Date().toISOString(),updated_at:new Date().toISOString(),due_date:'2025-12-05',completed:false,priority:1,priorityText:'中'},
        {id:uid(),title:'提交周报',description:'',created_at:new Date().toISOString(),updated_at:new Date().toISOString(),due_date:'2025-12-01',completed:true,priority:2,priorityText:'高'},
        {id:uid(),title:'写 PRD',description:'',created_at:new Date().toISOString(),updated_at:new Date().toISOString(),due_date:'',completed:false,priority:0,priorityText:'低'}
      ]
      save()
    }

    render()
  </script>
</body>
</html>